<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>WriteQuestï¼šå¯«æ–‡éŠæˆ²åŒ–</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <style>
    :root{--bg:#0f1115;--card:#171923;--muted:#8a8f98;--acc:#27c93f;--danger:#ff5555;--text:#e2e8f0;}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;background:var(--bg);font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, "PingFang TC","Noto Sans TC",sans-serif;color:var(--text);}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0f1115,rgba(15,17,21,0.85));backdrop-filter: blur(6px);padding:12px 16px;border-bottom:1px solid #222;}
    h1{font-size:18px;margin:0}
    main{padding:16px;display:grid;gap:12px}
    .card{background:var(--card);border:1px solid #242635;border-radius:14px;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{background:#22273a;border:1px solid #2e334b;border-radius:10px;color:var(--text);padding:10px 12px;font-size:15px}
    button.primary{background: #1f6feb;border-color:#2b74ff}
    button.ghost{background:transparent;border-color:#333;color:#cbd5e1}
    input,select,textarea{width:100%;background:#10131b;border:1px solid #2a3045;border-radius:10px;color:var(--text);padding:10px;font-size:15px}
    textarea{min-height:160px;resize:vertical}
    .muted{color:var(--muted);font-size:13px}
    .bar{height:10px;background:#0e0f14;border-radius:6px;border:1px solid #2a3045;overflow:hidden}
    .bar>div{height:100%;background:linear-gradient(90deg,#2b74ff,#27c93f);width:0%}
    .kpi{display:flex;gap:10px}
    .kpi div{flex:1;background:#10131b;border:1px solid #252b40;border-radius:12px;padding:10px;text-align:center}
    .kpi strong{font-size:18px;display:block}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#13221a;border:1px solid #23492e;color:#b7ffca;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:13px}
    .danger{color:#ffb3b3}
    .small{font-size:12px}
    .list{display:grid;gap:10px}
    .list .item{display:flex;justify-content:space-between;align-items:center;background:#10131b;border:1px solid #252b40;border-radius:12px;padding:10px}
    .link{color:#8ab4ff;text-decoration:underline;text-underline-offset:3px}
    .spacer{height:8px}
    .pill{padding:6px 10px;border-radius:999px;background:#1b1f2e;border:1px solid #30395d;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>WriteQuest â€” å¯«æ–‡éŠæˆ²åŒ–</h1>
    <div class="muted small">é›¢ç·šå¯ç”¨ï¼è³‡æ–™å­˜æ–¼æœ¬æ©Ÿï¼å¯åŒ¯å‡ºå‚™ä»½</div>
  </header>
  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted small">è§’è‰²</div>
          <div id="roleName" style="font-weight:600;font-size:16px">æ–‡å­¸è¦‹ç¿’ç”Ÿ Lv.<span id="lvl">1</span></div>
        </div>
        <div class="kpi">
          <div><div class="small muted">EXP</div><strong id="xp">0</strong></div>
          <div><div class="small muted">ç¸½å­—æ•¸</div><strong id="totalWords">0</strong></div>
          <div><div class="small muted">é€£çºŒå¤©æ•¸</div><strong id="streak">0</strong></div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="muted small">ç­‰ç´šé€²åº¦</div>
      <div class="bar"><div id="xpBar"></div></div>
      <div class="small muted" id="xpNote"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div class="muted small">ä»Šæ—¥ä»»å‹™</div>
          <div style="font-weight:600">è‡³å°‘ 150 å­—ï¼ˆæ¯ 100 å­— +10 EXPï¼‰</div>
        </div>
        <div class="row">
          <select id="genre">
            <option value="éš¨ç­†">éš¨ç­†</option>
            <option value="å¤§ç¶±">å¤§ç¶±</option>
            <option value="åŠ‡æœ¬">åŠ‡æœ¬</option>
            <option value="å°èªª">å°èªª</option>
            <option value="è©©">è©©</option>
          </select>
          <button id="roll" class="ghost">æŠ½éˆæ„Ÿé¡Œç›®</button>
        </div>
      </div>
      <div class="spacer"></div>
      <textarea id="entry" placeholder="é–‹å§‹å¯«å§ã€‚å®Œæˆå¾Œé»ã€æäº¤ä»Šæ—¥ã€ã€‚"></textarea>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="muted">å­—æ•¸ï¼š<span id="count">0</span></div>
        <div class="row">
          <button id="saveDraft" class="ghost">æš«å­˜</button>
          <button id="submit" class="primary">æäº¤ä»Šæ—¥</button>
        </div>
      </div>
      <div class="small muted">æç¤ºï¼šè¶…é 1000 å­—å¯è§£é–ã€Œé•·ç¯‡å‹‡è€…ã€å¾½ç« ï¼›é€£çºŒ 7 / 14 / 30 å¤©æœ‰å°æ‡‰å¾½ç« ã€‚</div>
    </section>

    <section class="card">
      <div class="muted small">å¾½ç« </div>
      <div id="badges"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted small">æ­·å²ç´€éŒ„ï¼ˆèˆ‡è‡ªå·±ç«¶è³½ï¼‰</div>
          <div class="small muted">é»é–‹å¯æŸ¥çœ‹ç•¶æ—¥æ¢ç›®</div>
        </div>
        <div class="row">
          <button id="exportBtn" class="ghost">åŒ¯å‡º JSON</button>
          <input type="file" id="importFile" accept="application/json" style="display:none">
          <button id="importBtn" class="ghost">åŒ¯å…¥</button>
          <button id="resetBtn" class="ghost danger">é‡ç½®</button>
        </div>
      </div>
      <div class="list" id="history"></div>
    </section>

    <section class="card">
      <div class="muted small">ç³»çµ±èªªæ˜</div>
      <ul class="small">
        <li>EXPï¼šæ¯ 100 å­— +10ï¼›æ¯æ—¥ä»»å‹™å®Œæˆå¦çµ¦ +30ã€‚</li>
        <li>ç­‰ç´šï¼šLv = floor( sqrt( EXP / 50 ) ) + 1ï¼›å‡ç´šé–€æª»é€æ­¥æé«˜ã€‚</li>
        <li>å¾½ç« ï¼š7/14/30 æ—¥é€£çºŒã€å–®ç¯‡ 1000 å­—ã€å˜—è©¦ 4 ç¨®ä¸åŒæ–‡é«”ã€ç•¶æœˆé”æˆ 20 å¤©ç­‰ã€‚</li>
        <li>è³‡æ–™åªå­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚å»ºè­°å®šæœŸã€ŒåŒ¯å‡º JSONã€å‚™ä»½ã€‚</li>
        <li>å¯å®‰è£ç‚ºæ¡Œé¢ Appï¼ˆPWAï¼‰ã€‚</li>
      </ul>
    </section>
  </main>

<script>
// ==== Utilities & Storage ====
const $ = (sel)=>document.querySelector(sel);
const todayKey = ()=> new Date().toISOString().slice(0,10);
const LSKEY = 'writequest:v1';

const defaultState = {
  profile:{name:'æ–‡å­¸è¦‹ç¿’ç”Ÿ'},
  xp:0,
  totalWords:0,
  entries:{}, // date -> {text, words, genre}
  badges:[],
  streak:0,
  lastDate:null,
  genresUsed:{} // monthKey -> Set
};

let S = load();
function load(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(!raw) return structuredClone(defaultState);
    const obj = JSON.parse(raw);
    return Object.assign(structuredClone(defaultState), obj);
  }catch(e){
    console.error(e);
    return structuredClone(defaultState);
  }
}
function save(){
  localStorage.setItem(LSKEY, JSON.stringify(S));
  render();
}

// ==== XP & Level ====
function xpForLevel(lv){ return (lv-1)**2 * 50; } // inverse of level formula approx
function currentLevel(xp){
  // lv such that xpForLevel(lv) <= xp < xpForLevel(lv+1)
  let lv=1;
  while(xp >= xpForLevel(lv+1)) lv++;
  return lv;
}

// ==== Streak ====
function dateDiffDays(a,b){ // a,b in 'YYYY-MM-DD'
  const da = new Date(a+"T00:00:00Z");
  const db = new Date(b+"T00:00:00Z");
  return Math.round((db-da)/(1000*60*60*24));
}
function updateStreak(submitDate){
  if(!S.lastDate){ S.streak = 1; }
  else{
    const diff = dateDiffDays(S.lastDate, submitDate);
    if(diff === 1) S.streak += 1;
    else if(diff === 0) { /* same day */ }
    else S.streak = 1;
  }
  S.lastDate = submitDate;
}

// ==== Badges ====
function hasBadge(code){ return S.badges.includes(code); }
function award(code){
  if(!hasBadge(code)){ S.badges.push(code); toast('è§£é–å¾½ç« ï¼š'+badgeMeta[code].name); }
}
const badgeMeta = {
  streak7:{name:'ç†¬éæ–°æ‰‹æ‘', desc:'é€£çºŒ 7 å¤©å®Œæˆæ¯æ—¥ä»»å‹™'},
  streak14:{name:'æŒçºŒè€…ä¹‹è­‰', desc:'é€£çºŒ 14 å¤©å®Œæˆæ¯æ—¥ä»»å‹™'},
  streak30:{name:'æ†æ¯…ä¹‹å°', desc:'é€£çºŒ 30 å¤©å®Œæˆæ¯æ—¥ä»»å‹™'},
  long1000:{name:'é•·ç¯‡å‹‡è€…', desc:'å–®ç¯‡ 1000 å­—ä»¥ä¸Š'},
  genres4:{name:'å¤šé¢æ‰‹', desc:'æœ¬æœˆå˜—è©¦ 4 ç¨®ä¸åŒæ–‡é«”'},
  month20:{name:'å‹¤å¥®ä¹‹æœˆ', desc:'ç•¶æœˆå®Œæˆ 20 å¤©æ¯æ—¥ä»»å‹™'}
};

// ==== Prompts ====
const prompts = [
 'å¯«ä¸€æ®µå®Œå…¨ä¸ç”¨ã€Œæ˜¯ã€å­—çš„çŸ­æ–‡ã€‚',
 'æè¿°ä»Šå¤©æœ€æƒ³æŒ‰æš«åœçš„ä¸€åˆ»ã€‚',
 'ä»¥ã€Œå¦‚æœæˆ‘åªèƒ½ä¿ç•™ä¸€å€‹ç¿’æ…£ã€ç‚ºé¡Œã€‚',
 'å¯«ä¸€å°çµ¦ä¸‰å¹´å¾Œè‡ªå·±çš„ä¿¡ï¼ˆ200 å­—å…§ï¼‰ã€‚',
 'æŠŠä¸€å€‹å¹³å‡¡ç‰©å“å¯«å¾—åƒå‚³å®¶å¯¶ã€‚',
 'ç”¨ä¸‰å€‹é¡é ­æè¿°ä¸€å€‹å ´æ™¯ï¼ˆå½±åƒå¼å¯«æ³•ï¼‰ã€‚',
 'æŠŠä»Šå¤©çš„æƒ…ç·’æ“¬äººåŒ–ï¼Œçµ¦å®ƒä¸€å€‹ä»»å‹™ã€‚',
 'ç”¨ã€Œæˆ‘æœ¬ä»¥ç‚ºâ€¦çµæœâ€¦ã€é–‹é ­å¯« 5 å¥ã€‚',
 'ç”¨å°è©±å¯«å‡ºå…©äººçš„èª¤æœƒï¼Œé™åˆ¶ 150â€“250 å­—ã€‚'
];

// ==== UI hooks ====
const countEl = $('#count');
const entry = $('#entry');
const genreSel = $('#genre');

entry.addEventListener('input',()=>{
  const words = entry.value.trim().length;
  countEl.textContent = words;
  localStorage.setItem('writequest:draft', JSON.stringify({text:entry.value, genre: genreSel.value}));
});

$('#saveDraft').addEventListener('click',()=>{
  localStorage.setItem('writequest:draft', JSON.stringify({text:entry.value, genre: genreSel.value}));
  toast('å·²æš«å­˜');
});
const draftRaw = localStorage.getItem('writequest:draft');
if(draftRaw){
  try{ const d = JSON.parse(draftRaw); entry.value = d.text || ''; genreSel.value = d.genre || 'éš¨ç­†'; countEl.textContent = entry.value.trim().length; }catch{}
}

$('#roll').addEventListener('click',()=>{
  const p = prompts[Math.floor(Math.random()*prompts.length)];
  entry.placeholder = p;
});

$('#submit').addEventListener('click',()=>{
  const text = entry.value.trim();
  const words = text.length;
  if(words < 1){ toast('è‡³å°‘å…ˆå¯«å¹¾å€‹å­—å§'); return; }
  const date = todayKey();
  const already = S.entries[date];
  if(already){ if(!confirm('ä»Šå¤©å·²æäº¤ï¼Œè¦†è“‹å—ï¼Ÿ')) return; }

  // Save entry
  S.entries[date] = {text, words, genre: genreSel.value, ts: Date.now()};
  S.totalWords += words - (already? already.words: 0);

  // XP: 10 per 100 chars, daily bonus 30 if >=150
  const gained = Math.floor(words/100)*10 + (words>=150?30:0);
  S.xp += gained - (already? already._gained||0 : 0);
  S.entries[date]._gained = gained;

  // streak
  updateStreak(date);

  // badges
  if(words >= 1000) award('long1000');
  if(S.streak >= 7) award('streak7');
  if(S.streak >= 14) award('streak14');
  if(S.streak >= 30) award('streak30');

  // genres diversity per month
  const monthKey = date.slice(0,7);
  if(!S.genresUsed[monthKey]) S.genresUsed[monthKey] = {};
  S.genresUsed[monthKey][genreSel.value] = true;
  const genresCount = Object.keys(S.genresUsed[monthKey]).length;
  if(genresCount >= 4) award('genres4');

  // month 20 days badge
  const monthCount = Object.keys(S.entries).filter(d => d.startsWith(monthKey)).length;
  if(monthCount >= 20) award('month20');

  save();
  localStorage.removeItem('writequest:draft');
  entry.value = ''; countEl.textContent = 0;
  toast(`å·²æäº¤ï¼š+${gained} EXP`);
});

$('#exportBtn').addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify(S,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'writequest-backup.json';
  a.click();
  URL.revokeObjectURL(a.href);
});

$('#importBtn').addEventListener('click',()=>$('#importFile').click());
$('#importFile').addEventListener('change',(ev)=>{
  const file = ev.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const data = JSON.parse(reader.result);
      if(!data || !data.entries) throw new Error('æ ¼å¼ä¸ç¬¦');
      S = Object.assign(structuredClone(defaultState), data);
      save();
      toast('åŒ¯å…¥æˆåŠŸ');
    }catch(e){
      alert('åŒ¯å…¥å¤±æ•—ï¼š' + e.message);
    }
  };
  reader.readAsText(file);
});

$('#resetBtn').addEventListener('click',()=>{
  if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯é€†ã€‚')){
    S = structuredClone(defaultState);
    save();
  }
});

function render(){
  // Header KPIs
  const lvl = currentLevel(S.xp);
  $('#lvl').textContent = lvl;
  $('#xp').textContent = S.xp;
  $('#totalWords').textContent = S.totalWords;
  $('#streak').textContent = S.streak;

  // XP bar
  const cur = S.xp - xpForLevel(lvl);
  const next = xpForLevel(lvl+1) - xpForLevel(lvl);
  const pct = Math.max(0, Math.min(100, Math.floor((cur/next)*100)));
  $('#xpBar').style.width = pct + '%';
  $('#xpNote').textContent = `è·é›¢ Lv.${lvl+1} é‚„éœ€ ${next-cur} EXP`;

  // Badges
  const box = $('#badges'); box.innerHTML='';
  const all = Object.keys(badgeMeta);
  all.forEach(code=>{
    const owned = hasBadge(code);
    const el = document.createElement('span');
    el.className = 'badge';
    el.style.opacity = owned?1:0.35;
    el.textContent = (owned?'ğŸ… ':'ğŸ”’ ') + badgeMeta[code].name;
    el.title = badgeMeta[code].desc;
    box.appendChild(el);
  });

  // History
  const hist = $('#history'); hist.innerHTML='';
  const dates = Object.keys(S.entries).sort().reverse();
  dates.forEach(d=>{
    const it = S.entries[d];
    const div = document.createElement('div');
    div.className = 'item';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${d}</strong> <span class="pill">${it.genre}</span> <span class="muted small">${it.words} å­—</span>`;
    const right = document.createElement('div');
    const btn = document.createElement('button');
    btn.textContent = 'æŸ¥çœ‹';
    btn.onclick = ()=>{
      alert(`${d}ï½œ${it.genre}\nå­—æ•¸ï¼š${it.words}\n\n${it.text}`);
    };
    right.appendChild(btn);
    div.appendChild(left); div.appendChild(right);
    hist.appendChild(div);
  });
}
function toast(msg){
  const div = document.createElement('div');
  div.textContent = msg;
  div.style.position='fixed'; div.style.bottom='20px'; div.style.left='50%'; div.style.transform='translateX(-50%)';
  div.style.background='#1f6feb'; div.style.color='white'; div.style.padding='10px 14px'; div.style.borderRadius='10px'; div.style.boxShadow='0 8px 20px rgba(0,0,0,.35)';
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),1800);
}
render();

// PWA
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js');
  });
}
</script>
</body>
</html>